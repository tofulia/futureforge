<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KokuPocket - Merit Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: linear-gradient(135deg, #fdf6f8 0%, #f0e6ff 100%); color: #333; scroll-behavior: smooth; min-height: 100vh; }
        h1, h2, h3 { font-weight: 700; }
        h1 { font-size: 2.5rem; background: linear-gradient(135deg, #7aa67a 0%, #5f8d5f 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        h2 { font-size: 2rem; background: linear-gradient(135deg, #7aa67a 0%, #5f8d5f 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        h3 { color: #7aa67a; font-size: 1.3rem; }
        section { padding: 60px 20px; }
        .container { max-width: 1100px; margin: auto; }
        nav { background: linear-gradient(135deg, #f8c8dc 0%, #f5b3d4 100%); padding: 20px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 10px 30px rgba(122, 166, 122, 0.1); }
        .nav-container { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: auto; }
        .nav-container h3 { background: linear-gradient(135deg, #7aa67a 0%, #5f8d5f 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 26px; margin: 0; font-weight: 800; }
        .nav-links { display: flex; gap: 25px; }
        .nav-links a { text-decoration: none; color: #333; font-weight: 650; transition: all 0.3s ease; position: relative; font-size: 15px; cursor: pointer; }
        .nav-links a:hover { color: #7aa67a; transform: translateY(-2px); }
        .nav-button { background: linear-gradient(135deg, #7aa67a 0%, #5f8d5f 100%); color: white; padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; }
        .nav-button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(122, 166, 122, 0.3); }
        .card { background: white; padding: 45px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.08); transition: all 0.4s; border: 1px solid rgba(122, 166, 122, 0.15); }
        .card:hover { transform: translateY(-12px); box-shadow: 0 30px 60px rgba(122, 166, 122, 0.2); }
        button { background: linear-gradient(135deg, #7aa67a 0%, #5f8d5f 100%); color: white; border: none; padding: 16px 35px; border-radius: 35px; cursor: pointer; font-weight: 700; transition: all 0.3s ease; margin-top: 15px; box-shadow: 0 10px 25px rgba(122, 166, 122, 0.35); font-size: 15px; text-transform: uppercase; letter-spacing: 1px; }
        button:hover { transform: translateY(-4px); box-shadow: 0 15px 35px rgba(122, 166, 122, 0.5); }
        form { display: flex; flex-direction: column; gap: 15px; }
        input, select, textarea { padding: 14px 18px; border-radius: 15px; border: 2px solid #e8e8e8; font-size: 15px; transition: all 0.3s ease; background: #f9f9f9; font-weight: 500; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #7aa67a; background: white; box-shadow: 0 0 0 4px rgba(122, 166, 122, 0.12); }
        .error { color: #c92a2a; font-size: 14px; font-weight: 700; padding: 14px 16px; background: linear-gradient(135deg, #ffe0e0 0%, #ffebeb 100%); border-radius: 12px; border-left: 5px solid #d9534f; display: none; }
        .success { color: #2b8a2b; font-size: 14px; font-weight: 700; padding: 14px 16px; background: linear-gradient(135deg, #e0ffe0 0%, #ebffeb 100%); border-radius: 12px; border-left: 5px solid #5cb85c; display: none; }
        .error.show, .success.show { display: block; }
        .page { display: none; }
        .page.active { display: block; }
        .result-card { margin-top: 30px; padding: 40px; border-radius: 25px; background: linear-gradient(135deg, #f0fff0 0%, #e8f5e9 100%); text-align: center; font-weight: 600; border: 3px solid #7aa67a; animation: glitter 0.6s ease-in-out; box-shadow: 0 15px 40px rgba(122, 166, 122, 0.25); }
        .result-percentage { font-size: 96px; font-weight: 900; background: linear-gradient(135deg, #7aa67a 0%, #5f8d5f 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 25px 0 15px; animation: glitterSpin 0.8s ease-out; }
        @keyframes glitter { 0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 15px 40px rgba(122, 166, 122, 0.25); } 50% { opacity: 1; transform: scale(1.05); box-shadow: 0 20px 50px rgba(122, 166, 122, 0.45); } }
        @keyframes glitterSpin { 0% { transform: scale(0.4) rotate(-15deg); opacity: 0; } 50% { transform: scale(1.15) rotate(8deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0); } 50% { opacity: 1; } }
        .sparkle { position: absolute; pointer-events: none; font-size: 32px; animation: sparkle 0.6s ease-out forwards; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .stat-card { background: linear-gradient(135deg, #f0fff0 0%, #e8f5e9 100%); padding: 25px; border-radius: 15px; border-left: 5px solid #7aa67a; text-align: center; }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: #7aa67a; }
        .stat-label { color: #666; margin-top: 10px; font-weight: 600; }
        .history-card { background: linear-gradient(135deg, #f9f9f9 0%, #f5f5f5 100%); padding: 18px; border-radius: 15px; border-left: 5px solid #7aa67a; margin-bottom: 15px; font-size: 13px; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.06); }
        .history-card:hover { transform: translateX(8px); box-shadow: 0 8px 20px rgba(122, 166, 122, 0.15); }
        .history-card-title { font-weight: 700; color: #7aa67a; margin-bottom: 10px; font-size: 14px; }
        .history-card-detail { color: #666; margin: 5px 0; line-height: 1.6; }
        .calc-field { display: flex; flex-direction: column; }
        .calc-field label { font-weight: 750; margin-bottom: 10px; color: #7aa67a; font-size: 14px; text-transform: uppercase; letter-spacing: 0.8px; }
        footer { text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f8c8dc 0%, #f5b3d4 100%); margin-top: 80px; font-weight: 700; color: #555; box-shadow: 0 -10px 30px rgba(0,0,0,0.06); }
        .clear-btn { background: linear-gradient(135deg, #d9534f 0%, #c9302c 100%); }
        .logout-btn { background: linear-gradient(135deg, #d9534f 0%, #c9302c 100%); padding: 8px 16px; font-size: 13px; margin-top: 0; }
        @media (max-width: 768px) { h1 { font-size: 2rem; } h2 { font-size: 1.6rem; } .nav-links { flex-direction: column; gap: 12px; } .card { padding: 30px; } .result-percentage { font-size: 64px; } button { padding: 14px 28px; font-size: 14px; } .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="loginPage" class="page active">
        <nav>
            <div class="nav-container">
                <h3>üéØ KokuPocket</h3>
            </div>
        </nav>
        <section style="padding-top: 100px;">
            <div class="container">
                <div class="card" style="max-width: 500px; margin: 0 auto;">
                    <h2 style="margin-bottom: 30px; text-align: center;">Welcome Back!</h2>
                    <form id="loginForm">
                        <input type="text" id="loginMatric" placeholder="Matric ID" required>
                        <input type="password" id="loginPassword" placeholder="Password" required>
                        <span class="error" id="loginError"></span>
                        <button type="submit">Sign In</button>
                    </form>
                    <p style="text-align: center; margin-top: 20px; color: #666;">Don't have an account? <a href="#" onclick="showPage('registerPage')" style="color: #7aa67a; font-weight: 700; cursor: pointer;">Create one</a></p>
                </div>
            </div>
        </section>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="page">
        <nav>
            <div class="nav-container">
                <h3>üéØ KokuPocket</h3>
            </div>
        </nav>
        <section style="padding-top: 100px;">
            <div class="container">
                <div class="card" style="max-width: 500px; margin: 0 auto;">
                    <h2 style="margin-bottom: 30px; text-align: center;">Create Account</h2>
                    <form id="registerForm">
                        <input type="text" id="regName" placeholder="Full Name" required>
                        <input type="text" id="regMatric" placeholder="Matric ID" required>
                        <input type="text" id="regIC" placeholder="Identification Number" required>
                        <input type="password" id="regPassword" placeholder="Password (min 6 chars)" required>
                        <span class="error" id="regError"></span>
                        <span class="success" id="regSuccess"></span>
                        <button type="submit">Create Account</button>
                    </form>
                    <p style="text-align: center; margin-top: 20px; color: #666;">Already have an account? <a href="#" onclick="showPage('loginPage')" style="color: #7aa67a; font-weight: 700; cursor: pointer;">Sign In</a></p>
                </div>
            </div>
        </section>
    </div>

    <!-- Calculator Page (After Login) -->
    <div id="calculatorPage" class="page">
        <nav>
            <div class="nav-container">
                <h3>üéØ KokuPocket</h3>
                <div class="nav-links">
                    <a href="#" onclick="showPage('dashboardPage')">üìä Dashboard</a>
                    <a href="#" onclick="showPage('calculatorPage')">‚ö° Calculator</a>
                    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
                </div>
            </div>
        </nav>
        <section>
            <div class="container">
                <h2 style="margin-bottom: 30px;">‚ö° Merit Calculator</h2>
                <div class="card">
                    <p style="margin-bottom:25px; font-size:15px; color:#666;">
                        <strong>Formula:</strong> (Total Points √∑ 110) √ó 10 = Your Merit Score
                    </p>
                    <form id="meritForm">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 25px;">
                            <div class="calc-field">
                                <label for="kehadiran">üìç Kehadiran (Attendance)</label>
                                <input type="number" id="kehadiran" min="0" max="30" placeholder="0-30" required>
                            </div>
                            <div class="calc-field">
                                <label for="penilaian">üìä Penilaian Berterusan</label>
                                <input type="number" id="penilaian" min="0" max="20" placeholder="0-20" required>
                            </div>
                        </div>
                        <div class="calc-field">
                            <label for="penglibatan">üé≠ Penglibatan (Participation)</label>
                            <select id="penglibatan" required>
                                <option value="">-- Select Level --</option>
                                <option value="20">‚≠ê Antara Matrikulasi/Zon/Kebangsaan</option>
                                <option value="17">ü•á Peringkat Kolej/Negeri</option>
                                <option value="14">ü•à Antara Praktikum</option>
                                <option value="11">ü•â Tutoran/Praktikum/Kolej Kediaman</option>
                            </select>
                        </div>
                        <div class="calc-field">
                            <label for="pencapaian">üèÖ Pencapaian (Achievement)</label>
                            <select id="pencapaian" required>
                                <option value="">-- Select Achievement --</option>
                                <option value="20">üëë Johan (Champion)</option>
                                <option value="19">üéñÔ∏è Naib Johan (Runner-up)</option>
                                <option value="18">üèÜ Ketiga (Third)</option>
                                <option value="15">üìú Participation Certificate</option>
                            </select>
                        </div>
                        <div class="calc-field">
                            <label for="jawatan">üíº Jawatan (Position)</label>
                            <select id="jawatan" required>
                                <option value="">-- Select Position --</option>
                                <option value="10">üë®‚Äçüíº YDP/NYDP/Setiausaha Agong JPP</option>
                                <option value="9">üìå Pengerusi/Ketua Pasukan</option>
                                <option value="8">üìç Timbalan Pengerusi/Setiausaha</option>
                                <option value="7">üîë Ketua Biro/Ahli Jawatankuasa</option>
                                <option value="6">‚úÖ Ahli Jawatankuasa Program</option>
                                <option value="5">ü§ù Ahli Biasa/Peserta</option>
                            </select>
                        </div>
                        <div class="calc-field">
                            <label for="bonus">üéÅ Bonus</label>
                            <select id="bonus" required>
                                <option value="">-- Select Bonus --</option>
                                <option value="10">üåü Anugerah Kecemerlangan</option>
                                <option value="9">üöÄ Mewakili 2+ Pertandingan Kebangsaan</option>
                                <option value="8">üí´ Terlibat 2+ Aktiviti Kolej</option>
                                <option value="7">‚ú® Terlibat 1+ Aktiviti Kolej</option>
                            </select>
                        </div>
                        <span class="error" id="calcError"></span>
                        <button type="submit">üéØ Calculate My Score</button>
                    </form>
                    <div id="result"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page">
        <nav>
            <div class="nav-container">
                <h3>üéØ KokuPocket</h3>
                <div class="nav-links">
                    <a href="#" onclick="showPage('dashboardPage')">üìä Dashboard</a>
                    <a href="#" onclick="showPage('calculatorPage')">‚ö° Calculator</a>
                    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
                </div>
            </div>
        </nav>
        <section>
            <div class="container">
                <h2 style="margin-bottom: 30px;">üìä Your Dashboard</h2>
                <div id="dashboardContent">Loading...</div>
            </div>
        </section>
    </div>

    <footer>
        ¬© 2026 KokuPocket | Merit Innovation System | Empowering Student Excellence
    </footer>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let currentUserId = localStorage.getItem('userId');

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            if (pageName === 'dashboardPage') loadDashboard();
        }

        function setError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function setSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('regName').value.trim();
            const matric = document.getElementById('regMatric').value.trim();
            const ic = document.getElementById('regIC').value.trim();
            const password = document.getElementById('regPassword').value.trim();

            if (password.length < 6) {
                setError('regError', '‚ùå Password must be at least 6 characters');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, matric, ic, password })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    setError('regError', `‚ùå ${data.error}`);
                    return;
                }

                setSuccess('regSuccess', '‚úÖ Account created! Redirecting...');
                authToken = data.token;
                currentUserId = data.userId;
                currentUser = { name, matric };
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('userId', currentUserId);
                localStorage.setItem('userName', name);

                setTimeout(() => showPage('calculatorPage'), 1500);
            } catch (error) {
                setError('regError', `‚ùå Error: ${error.message}`);
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const matric = document.getElementById('loginMatric').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ matric, password })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    setError('loginError', `‚ùå ${data.error}`);
                    return;
                }

                authToken = data.token;
                currentUserId = data.userId;
                currentUser = { name: data.name, matric: data.matric };
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('userId', currentUserId);
                localStorage.setItem('userName', data.name);

                showPage('calculatorPage');
            } catch (error) {
                setError('loginError', `‚ùå Error: ${error.message}`);
            }
        });

        // Calculate
        document.getElementById('meritForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const kehadiran = Number(document.getElementById('kehadiran').value);
            const penilaian = Number(document.getElementById('penilaian').value);
            const penglibatan = Number(document.getElementById('penglibatan').value);
            const pencapaian = Number(document.getElementById('pencapaian').value);
            const jawatan = Number(document.getElementById('jawatan').value);
            const bonus = Number(document.getElementById('bonus').value);

            if (!kehadiran || !penilaian || !penglibatan || !pencapaian || !jawatan || !bonus) {
                setError('calcError', '‚ùå Please fill in all fields');
                return;
            }

            const total = kehadiran + penilaian + penglibatan + pencapaian + jawatan + bonus;
            const finalPercent = ((total / 110) * 10).toFixed(2);

            try {
                const response = await fetch(`${API_URL}/calc/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ kehadiran, penilaian, penglibatan, pencapaian, jawatan, bonus, total, finalPercent })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `
                    <div class="result-card">
                        <div style="margin-bottom: 20px; font-size: 15px;">
                            <div>üìç Kehadiran: <strong>${kehadiran}</strong>/30</div>
                            <div>üìä Penilaian: <strong>${penilaian}</strong>/20</div>
                            <div>üé≠ Penglibatan: <strong>${penglibatan}</strong>/20</div>
                            <div>üèÖ Pencapaian: <strong>${pencapaian}</strong>/20</div>
                            <div>üíº Jawatan: <strong>${jawatan}</strong>/10</div>
                            <div>üéÅ Bonus: <strong>${bonus}</strong>/10</div>
                        </div>
                        <hr style="margin: 20px 0; border: none; border-top: 2px solid rgba(122, 166, 122, 0.3);">
                        <div style="margin-bottom: 15px;">üìä Total Points: <strong>${total}</strong> / 110</div>
                        <div class="result-percentage">${finalPercent}%</div>
                        <div style="font-size: 18px; color: #7aa67a; font-weight: 700;">‚ú® Your Cocurriculum Merit Score ‚ú®</div>
                    </div>
                `;
                createSparkles(resultDiv);
            } catch (error) {
                setError('calcError', `‚ùå ${error.message}`);
            }
        });

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_URL}/calc/dashboard`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                const stats = data.stats;
                const html = `
                    <div class="card" style="margin-bottom: 30px;">
                        <h3>üë§ Welcome, ${data.user.name}!</h3>
                        <p style="color: #666; margin-top: 10px;">Matric: <strong>${data.user.matric}</strong></p>
                    </div>
                    <h3 style="margin: 30px 0 20px;">üìà Your Statistics</h3>
                    <div class="grid">
                        <div class="stat-card">
                            <div class="stat-number">${stats.totalCalculations}</div>
                            <div class="stat-label">Total Calculations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.averageScore || 0}</div>
                            <div class="stat-label">Average Score (%)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.highestScore || 0}</div>
                            <div class="stat-label">Highest Score (%)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.lowestScore || 0}</div>
                            <div class="stat-label">Lowest Score (%)</div>
                        </div>
                    </div>
                    <h3 style="margin: 40px 0 20px;">üìã Calculation History</h3>
                    <div class="card">
                        ${data.calculations.length > 0 ? data.calculations.map((calc, i) => `
                            <div class="history-card">
                                <div class="history-card-title">Calculation #${i + 1} - Score: ${calc.finalPercent}% üéØ</div>
                                <div class="history-card-detail"><strong>Total:</strong> ${calc.total}/110 points</div>
                                <div class="history-card-detail">Details: Kehadiran ${calc.kehadiran} | Penilaian ${calc.penilaian} | Penglibatan ${calc.penglibatan} | Pencapaian ${calc.pencapaian} | Jawatan ${calc.jawatan} | Bonus ${calc.bonus}</div>
                                <div class="history-card-detail"><strong>Date:</strong> ${new Date(calc.timestamp).toLocaleString()}</div>
                            </div>
                        `).join('') : '<p style="color: #999;">No calculations yet. Start calculating to see your history!</p>'}
                    </div>
                `;
                document.getElementById('dashboardContent').innerHTML = html;
            } catch (error) {
                console.error('Dashboard error:', error);
                document.getElementById('dashboardContent').innerHTML = `<div class="card"><p style="color: red;">Error loading dashboard: ${error.message}</p></div>`;
            }
        }

        function createSparkles(container) {
            const sparkles = ['‚ú®', '‚≠ê', 'üí´', 'üåü', '‚ö°'];
            for (let i = 0; i < 12; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.top = Math.random() * 100 + '%';
                sparkle.style.animationDelay = (i * 0.08) + 's';
                container.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 700);
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            document.getElementById('loginMatric').value = '';
            document.getElementById('loginPassword').value = '';
            showPage('loginPage');
        }

        // Check if already logged in
        if (authToken && currentUserId) {
            showPage('calculatorPage');
        }
    </script>

</body>
</html>
